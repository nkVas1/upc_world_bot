---
title: PHASE 3 - Telegram API Photo Fix & Access Code TTL
created: 2025-01-XX
status: –ì–û–¢–û–í–û –ö –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–Æ
---

# üîß PHASE 3: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –∏ TTL

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π

### ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #1: AttributeError - telegram_user.photo_id –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–û—à–∏–±–∫–∞:**
```
AttributeError: User object has no attribute 'photo_id'
```

**–ü—Ä–∏—á–∏–Ω–∞:** Telegram API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞—Ç—Ä–∏–±—É—Ç `photo_id` –Ω–∞–ø—Ä—è–º—É—é –≤ –æ–±—ä–µ–∫—Ç–µ User. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏–±–æ:
- WebApp –ø–µ—Ä–µ–¥–∞—ë—Ç —Ñ–æ—Ç–æ_URL
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bot.get_profile_photos(user_id)` (—Ç—Ä–µ–±—É–µ—Ç context)

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- **–§–∞–π–ª:** `bot/services/user_service.py`
- **–°—Ç—Ä–æ–∫–∏:** 45, 59
- **–î–µ–π—Å—Ç–≤–∏–µ:** –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `if telegram_user.photo_id:` –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç AttributeError
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ö–æ–¥ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚ùå –ë–´–õ–û
if telegram_user.photo_id and not user.photo_url:
    updates["photo_url"] = f"tg://user/{telegram_user.id}"
```

**–ö–æ–¥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚úÖ –°–¢–ê–õ–û
# Note: Telegram API doesn't provide direct photo_id in User object
# Photo URL should come from WebApp or profile photo retrieval API
# Skipping photo update check to prevent AttributeError
```

---

### ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ photo_id –ø–æ–ª—è –≤ User –º–æ–¥–µ–ª–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–¥–µ–ª—å User –Ω–µ –∏–º–µ–ª–∞ –ø–æ–ª—è `photo_id` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Telegram file_id —Ñ–æ—Ç–æ

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- **–§–∞–π–ª:** `bot/database/models.py`
- **–°—Ç—Ä–æ–∫–∞:** 26
- **–î–µ–π—Å—Ç–≤–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `photo_id: Mapped[Optional[str]]`

**–ö–æ–¥ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚ùå –ë–´–õ–û
photo_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)
```

**–ö–æ–¥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
# ‚úÖ –°–¢–ê–õ–û
photo_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)
photo_id: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)  # Telegram photo file_id
```

---

### ‚úÖ –ü–†–û–ë–õ–ï–ú–ê #3: Access Code TTL –±—ã–ª —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û –†–ê–ù–ï–ï

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- **–§–∞–π–ª:** `bot/utils/token_storage.py`
- **–°—Ç—Ä–æ–∫–∞:** 22
- **–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** `CODE_TTL = 900` (15 –º–∏–Ω—É—Ç) ‚úÖ
- **–¢—Ä–µ–±—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** 600-900 —Å–µ–∫—É–Ω–¥ ‚úÖ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Access –∫–æ–¥—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 15 –º–∏–Ω—É—Ç - –ù–û–†–ú–ê–õ–¨–ù–û!

---

### üìä –ü–†–û–ë–õ–ï–ú–ê #4: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- **–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:** `alembic/versions/003_add_photo_id_field.py`
- **–î–µ–π—Å—Ç–≤–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è photo_id –∫–æ–ª–æ–Ω–∫–∏
- **SQL –æ–ø–µ—Ä–∞—Ü–∏—è:** `ALTER TABLE users ADD COLUMN photo_id VARCHAR(255) NULL;`

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Railway

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
```bash
# –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω ‚úÖ
# –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚úÖ
```

### –®–∞–≥ 2: Push –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub
```bash
git add -A
git commit -m "fix: resolve Telegram API photo_id attribute error and ensure photo_id field in database"
git push origin main
```

Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ó–∞–ø—É–ª–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. –ó–∞–ø—É—Å—Ç–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
3. –î–æ–±–∞–≤–∏—Ç photo_id –∫–æ–ª–æ–Ω–∫—É –≤ PostgreSQL
4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç –±–æ—Ç —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö Railway
–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:
```
INFO [alembic.runtime.migration] Running upgrade 002_add_photo_url -> 003_add_photo_id
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º PHASE 3 —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:

- [x] ‚ùå AttributeError –Ω–∞ `photo_id` –ò–°–ü–†–ê–í–õ–ï–ù (user_service.py)
- [x] photo_id –ø–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ User –º–æ–¥–µ–ª—å
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è 003 –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏
- [x] ACCESS_CODE TTL —É–∂–µ 900 —Å–µ–∫—É–Ω–¥ (15 –º–∏–Ω—É—Ç) ‚úÖ
- [ ] üöÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è pushed –Ω–∞ GitHub
- [ ] üöÄ Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª
- [ ] üß™ –ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏)
- [ ] üß™ `/start` –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] üß™ QR –∫–æ–¥—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] üß™ Access –∫–æ–¥—ã –Ω–µ –≤—ã–¥–∞—é—Ç "INVALID OR EXPIRED" –æ—à–∏–±–∫—É

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –§–∞–∑–∞ | –ü—Ä–æ–±–ª–µ–º—ã | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –°—Ç–∞—Ç—É—Å |
|------|---------|-----------|--------|
| PHASE 1 | 3 | 3 | ‚úÖ DEPLOYED |
| PHASE 2 | 5 | 5 | ‚úÖ DEPLOYED |
| PHASE 3 | 4 | 4 | üî¥ READY TO DEPLOY |

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. ‚úÖ `bot/services/user_service.py` - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ photo_id (2 –º–µ—Å—Ç–∞)
2. ‚úÖ `bot/database/models.py` - –î–æ–±–∞–≤–ª–µ–Ω–æ photo_id –ø–æ–ª–µ
3. ‚úÖ `alembic/versions/003_add_photo_id_field.py` - –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [PHASE_2_COMPLETE.md](./PHASE_2_COMPLETE.md)
- [FINAL_STATUS.md](./FINAL_STATUS.md)
- [MIGRATION_INSTRUCTIONS.md](./MIGRATION_INSTRUCTIONS.md)

---

**–§–ê–ó–ê –ì–û–¢–û–í–ê –ö –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–Æ –ù–ê RAILWAY!** üöÄ
